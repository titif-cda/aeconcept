/*!
 * storyblok-js-client v0.0.0-development
 * Universal JavaScript SDK for Storyblok's API
 * (c) 2020-2022 Stobylok Team
 */
"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var e=t(require("axios"));function r(t){return"number"==typeof t&&(t==t&&t!==1/0&&t!==-1/0)}function s(t,e,s){if(!r(e))throw new TypeError("Expected `limit` to be a finite number");if(!r(s))throw new TypeError("Expected `interval` to be a finite number");var n=[],i=[],o=0,a=function(){o++;var e=setTimeout((function(){o--,n.length>0&&a(),i=i.filter((function(t){return t!==e}))}),s);i.indexOf(e)<0&&i.push(e);var r=n.shift();r.resolve(t.apply(r.self,r.args))},l=function(){var t=arguments,r=this;return new Promise((function(s,i){n.push({resolve:s,reject:i,args:t,self:r}),o<e&&a()}))};return l.abort=function(){i.forEach(clearTimeout),i=[],n.forEach((function(t){t.reject(new throttle.AbortError)})),n.length=0},l}s.AbortError=function(){Error.call(this,"Throttled function aborted"),this.name="AbortError"};const n=function(t,e){if(!t)return null;let r={};for(let s in t){let n=t[s];e.indexOf(s)>-1&&null!==n&&(r[s]=n)}return r};var i={nodes:{horizontal_rule:t=>({singleTag:"hr"}),blockquote:t=>({tag:"blockquote"}),bullet_list:t=>({tag:"ul"}),code_block:t=>({tag:["pre",{tag:"code",attrs:t.attrs}]}),hard_break:t=>({singleTag:"br"}),heading:t=>({tag:"h"+t.attrs.level}),image:t=>({singleTag:[{tag:"img",attrs:n(t.attrs,["src","alt","title"])}]}),list_item:t=>({tag:"li"}),ordered_list:t=>({tag:"ol"}),paragraph:t=>({tag:"p"})},marks:{bold:()=>({tag:"b"}),strike:()=>({tag:"strike"}),underline:()=>({tag:"u"}),strong:()=>({tag:"strong"}),code:()=>({tag:"code"}),italic:()=>({tag:"i"}),link(t){const e={...t.attrs},{linktype:r="url"}=t.attrs;return"email"===r&&(e.href="mailto:"+e.href),e.anchor&&(e.href=`${e.href}#${e.anchor}`,delete e.anchor),{tag:[{tag:"a",attrs:e}]}},styled:t=>({tag:[{tag:"span",attrs:t.attrs}]})}};class o{constructor(t){t||(t=i),this.marks=t.marks||[],this.nodes=t.nodes||[]}addNode(t,e){this.nodes[t]=e}addMark(t,e){this.marks[t]=e}render(t={}){if(t.content&&Array.isArray(t.content)){let e="";return t.content.forEach(t=>{e+=this.renderNode(t)}),e}return console.warn("The render method must receive an object with a content field, which is an array"),""}renderNode(t){let e=[];t.marks&&t.marks.forEach(t=>{const r=this.getMatchingMark(t);r&&e.push(this.renderOpeningTag(r.tag))});const r=this.getMatchingNode(t);return r&&r.tag&&e.push(this.renderOpeningTag(r.tag)),t.content?t.content.forEach(t=>{e.push(this.renderNode(t))}):t.text?e.push(function(t){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},r=/[&<>"']/g,s=RegExp(r.source);return t&&s.test(t)?t.replace(r,t=>e[t]):t}(t.text)):r&&r.singleTag?e.push(this.renderTag(r.singleTag," /")):r&&r.html&&e.push(r.html),r&&r.tag&&e.push(this.renderClosingTag(r.tag)),t.marks&&t.marks.slice(0).reverse().forEach(t=>{const r=this.getMatchingMark(t);r&&e.push(this.renderClosingTag(r.tag))}),e.join("")}renderTag(t,e){if(t.constructor===String)return`<${t}${e}>`;return t.map(t=>{if(t.constructor===String)return`<${t}${e}>`;{let r="<"+t.tag;if(t.attrs)for(let e in t.attrs){let s=t.attrs[e];null!==s&&(r+=` ${e}="${s}"`)}return`${r}${e}>`}}).join("")}renderOpeningTag(t){return this.renderTag(t,"")}renderClosingTag(t){if(t.constructor===String)return`</${t}>`;return t.slice(0).reverse().map(t=>t.constructor===String?`</${t}>`:`</${t.tag}>`).join("")}getMatchingNode(t){if("function"==typeof this.nodes[t.type])return this.nodes[t.type](t)}getMatchingMark(t){if("function"==typeof this.marks[t.type])return this.marks[t.type](t)}}const a=(t=0,e=t)=>{const r=Math.abs(e-t)||0,s=t<e?1:-1;return((t=0,e)=>[...Array(t)].map(e))(r,(e,r)=>r*s+t)},l=(t,e,r)=>{const s=[];for(const n in t){if(!Object.prototype.hasOwnProperty.call(t,n))continue;const i=t[n],o=r?"":encodeURIComponent(n);let a;a="object"==typeof i?l(i,e?e+encodeURIComponent("["+o+"]"):o,Array.isArray(i)):(e?e+encodeURIComponent("["+o+"]"):o)+"="+encodeURIComponent(i),s.push(a)}return s.join("&")};let c={},h={};module.exports=class{constructor(t,r){if(!r){let e=t.region?"-"+t.region:"",s=!1===t.https?"http":"https";r=void 0===t.oauthToken?`${s}://api${e}.storyblok.com/v2`:`${s}://api${e}.storyblok.com/v1`}let n=Object.assign({},t.headers),i=5;void 0!==t.oauthToken&&(n.Authorization=t.oauthToken,i=3),void 0!==t.rateLimit&&(i=t.rateLimit),this.richTextResolver=new o(t.richTextSchema),"function"==typeof t.componentResolver&&this.setComponentResolver(t.componentResolver),this.maxRetries=t.maxRetries||5,this.throttle=s(this.throttledRequest,i,1e3),this.accessToken=t.accessToken,this.relations={},this.links={},this.cache=t.cache||{clear:"manual"},this.client=e.default.create({baseURL:r,timeout:t.timeout||0,headers:n,proxy:t.proxy||!1}),t.responseInterceptor&&this.client.interceptors.response.use(e=>t.responseInterceptor(e))}setComponentResolver(t){this.richTextResolver.addNode("blok",e=>{let r="";return e.attrs.body.forEach(e=>{r+=t(e.component,e)}),{html:r}})}parseParams(t={}){return t.version||(t.version="published"),t.token||(t.token=this.getToken()),t.cv||(t.cv=h[t.token]),Array.isArray(t.resolve_relations)&&(t.resolve_relations=t.resolve_relations.join(",")),t}factoryParamOptions(t,e={}){return((t="")=>t.indexOf("/cdn/")>-1)(t)?this.parseParams(e):e}makeRequest(t,e,r,s){const n=this.factoryParamOptions(t,((t={},e=25,r=1)=>({...t,per_page:e,page:r}))(e,r,s));return this.cacheResponse(t,n)}get(t,e){let r="/"+t;const s=this.factoryParamOptions(r,e);return this.cacheResponse(r,s)}async getAll(t,e={},r){const s=e.per_page||25,n="/"+t,i=n.split("/");r=r||i[i.length-1];const o=await this.makeRequest(n,e,s,1),l=Math.ceil(o.total/s);return((t=[],e)=>t.map(e).reduce((t,e)=>[...t,...e],[]))([o,...await(async(t=[],e)=>Promise.all(t.map(e)))(a(1,l),async t=>this.makeRequest(n,e,s,t+1))],t=>Object.values(t.data[r]))}post(t,e){let r="/"+t;return this.throttle("post",r,e)}put(t,e){let r="/"+t;return this.throttle("put",r,e)}delete(t,e){let r="/"+t;return this.throttle("delete",r,e)}getStories(t){return this.get("cdn/stories",t)}getStory(t,e){return this.get("cdn/stories/"+t,e)}setToken(t){this.accessToken=t}getToken(){return this.accessToken}_cleanCopy(t){return JSON.parse(JSON.stringify(t))}_insertLinks(t,e){const r=t[e];r&&"multilink"==r.fieldtype&&"story"==r.linktype&&"string"==typeof r.id&&this.links[r.id]?r.story=this._cleanCopy(this.links[r.id]):r&&"story"===r.linktype&&"string"==typeof r.uuid&&this.links[r.uuid]&&(r.story=this._cleanCopy(this.links[r.uuid]))}_insertRelations(t,e,r){if(r.indexOf(t.component+"."+e)>-1)if("string"==typeof t[e])this.relations[t[e]]&&(t[e]=this._cleanCopy(this.relations[t[e]]));else if(t[e].constructor===Array){let r=[];t[e].forEach(t=>{this.relations[t]&&r.push(this._cleanCopy(this.relations[t]))}),t[e]=r}}iterateTree(t,e){let r=t=>{if(null!=t)if(t.constructor===Array)for(let e=0;e<t.length;e++)r(t[e]);else if(t.constructor===Object){if(t._stopResolving)return;for(let s in t)(t.component&&t._uid||"link"===t.type)&&(this._insertRelations(t,s,e),this._insertLinks(t,s)),r(t[s])}};r(t.content)}async resolveLinks(t,e){let r=[];if(t.link_uuids){const s=t.link_uuids.length;let n=[];const i=50;for(let e=0;e<s;e+=i){const r=Math.min(s,e+i);n.push(t.link_uuids.slice(e,r))}for(let t=0;t<n.length;t++){(await this.getStories({per_page:i,language:e.language,version:e.version,by_uuids:n[t].join(",")})).data.stories.forEach(t=>{r.push(t)})}}else r=t.links;r.forEach(t=>{this.links[t.uuid]={...t,_stopResolving:!0}})}async resolveRelations(t,e){let r=[];if(t.rel_uuids){const s=t.rel_uuids.length;let n=[];const i=50;for(let e=0;e<s;e+=i){const r=Math.min(s,e+i);n.push(t.rel_uuids.slice(e,r))}for(let t=0;t<n.length;t++){(await this.getStories({per_page:i,language:e.language,version:e.version,by_uuids:n[t].join(",")})).data.stories.forEach(t=>{r.push(t)})}}else r=t.rels;r.forEach(t=>{this.relations[t.uuid]={...t,_stopResolving:!0}})}async resolveStories(t,e){let r=[];void 0!==e.resolve_relations&&e.resolve_relations.length>0&&(r=e.resolve_relations.split(","),await this.resolveRelations(t,e)),["1","story","url"].indexOf(e.resolve_links)>-1&&await this.resolveLinks(t,e);for(const t in this.relations)this.iterateTree(this.relations[t],r);t.story?this.iterateTree(t.story,r):t.stories.forEach(t=>{this.iterateTree(t,r)})}cacheResponse(t,e,r){return void 0===r&&(r=0),new Promise(async(s,n)=>{let i=l({url:t,params:e}),o=this.cacheProvider();if("auto"===this.cache.clear&&"draft"===e.version&&await this.flushCache(),"published"===e.version&&"/cdn/spaces/me"!=t){const t=await o.get(i);if(t)return s(t)}try{let r=await this.throttle("get",t,{params:e,paramsSerializer:t=>l(t)}),a={data:r.data,headers:r.headers};if(r.headers["per-page"]&&(a=Object.assign({},a,{perPage:parseInt(r.headers["per-page"]),total:parseInt(r.headers.total)})),200!=r.status)return n(r);(a.data.story||a.data.stories)&&await this.resolveStories(a.data,e),"published"===e.version&&"/cdn/spaces/me"!=t&&o.set(i,a),a.data.cv&&("draft"==e.version&&h[e.token]!=a.data.cv&&this.flushCache(),h[e.token]=a.data.cv),s(a)}catch(i){if(i.response&&429===i.response.status&&(r+=1)<this.maxRetries)return console.log(`Hit rate limit. Retrying in ${r} seconds.`),await(a=1e3*r,new Promise(t=>setTimeout(t,a))),this.cacheResponse(t,e,r).then(s).catch(n);n(i)}var a})}throttledRequest(t,e,r){return this.client[t](e,r)}cacheVersions(){return h}cacheVersion(){return h[this.accessToken]}setCacheVersion(t){this.accessToken&&(h[this.accessToken]=t)}cacheProvider(){switch(this.cache.type){case"memory":return{get:t=>c[t],getAll:()=>c,set(t,e){c[t]=e},flush(){c={}}};default:return{get(){},getAll(){},set(){},flush(){}}}}async flushCache(){return await this.cacheProvider().flush(),this}};
